---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import Button from '~/components/ui/Button.astro';

export interface Props {
  id?: string;
  title?: string;
  subtitle?: string;
  tagline?: string;
  email: string;
  services: string[];
}

const {
  id,
  title = 'Contattami',
  subtitle = 'Compila il form per richiedere informazioni o prenotare una visita',
  tagline = 'Contatti',
  email,
  services,
} = Astro.props;
---

<WidgetWrapper id={id} containerClass="max-w-7xl mx-auto">
  <Headline title={title} subtitle={subtitle} tagline={tagline} />

  <div class="flex flex-col max-w-xl mx-auto rounded-lg backdrop-blur border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 shadow p-4 sm:p-6 lg:p-8 w-full">
    <form id="contact-form" action={`https://formsubmit.co/ajax/${email}`} method="POST">
      <!-- Formsubmit config -->
      <input type="hidden" name="_subject" value="Nuova richiesta dal sito web" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_template" value="table" />
      <input type="text" name="_honey" style="display:none" />

      <!-- Nome e Cognome -->
      <div class="mb-6">
        <label for="nome" class="block text-sm font-medium mb-1">
          Nome e Cognome <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          name="nome"
          id="nome"
          required
          minlength="3"
          pattern="^[a-zA-ZàèéìòùÀÈÉÌÒÙáóúÁÓÚ '\-]+$"
          title="Inserisci nome e cognome (solo lettere)"
          placeholder="Mario Rossi"
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-primary"
        />
      </div>

      <!-- Email -->
      <div class="mb-6">
        <label for="email" class="block text-sm font-medium mb-1">
          Email <span class="text-red-500">*</span>
        </label>
        <input
          type="email"
          name="email"
          id="email"
          required
          pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
          title="Inserisci un indirizzo email valido (es. mario.rossi@email.com)"
          placeholder="mario.rossi@email.com"
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-primary"
        />
      </div>

      <!-- Tipo di visita -->
      <div class="mb-6">
        <label for="tipo_visita" class="block text-sm font-medium mb-1">
          Tipo di visita <span class="text-red-500">*</span>
        </label>
        <select
          name="tipo_visita"
          id="tipo_visita"
          required
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-primary"
        >
          <option value="" disabled selected>Scegli il tipo di visita</option>
          {services.map((service) => (
            <option value={service}>{service}</option>
          ))}
        </select>
      </div>

      <!-- Telefono -->
      <div class="mb-6">
        <label for="telefono" class="block text-sm font-medium mb-1">
          Telefono <span class="text-red-500">*</span>
        </label>
        <input
          type="tel"
          name="telefono"
          id="telefono"
          required
          pattern="^(\+39\s?)?((3[0-9]{2})\s?(\d{6,7})|(0[0-9]{1,3})\s?(\d{5,8}))$"
          title="Inserisci un numero di telefono valido (es. 333 1234567 o +39 333 1234567)"
          placeholder="+39 333 1234567"
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-primary"
        />
      </div>

      <!-- Note e data indicativa -->
      <div class="mb-6">
        <label for="note" class="block text-sm font-medium mb-1">
          Note e data indicativa
        </label>
        <textarea
          name="note"
          id="note"
          rows="4"
          placeholder="Inserisci eventuali note o la data preferita per l'appuntamento..."
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-primary"
        ></textarea>
      </div>

      <!-- Submit button -->
      <div class="mt-8 grid">
        <button
          id="submit-btn"
          type="submit"
          class="submit-btn py-3 px-6 text-white font-semibold rounded-lg bg-primary hover:bg-primary/90 transition-all duration-300 ease-in-out"
        >
          <span id="btn-content" class="flex items-center justify-center gap-2">
            <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M10 14l11 -11"></path>
              <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5"></path>
            </svg>
            <span id="btn-text">Invia richiesta</span>
          </span>
        </button>
      </div>

      <p class="mt-4 text-xs text-center text-gray-500 dark:text-gray-400">
        I tuoi dati saranno trattati nel rispetto della privacy. Ti ricontatterò al piu presto.
      </p>
    </form>
  </div>

  <Fragment slot="bg">
    <div class="absolute inset-0 bg-primary/5 dark:bg-transparent"></div>
  </Fragment>
</WidgetWrapper>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text') as HTMLSpanElement;
  const sendIcon = document.getElementById('send-icon');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Disabilita il pulsante e mostra stato di invio
    submitBtn.disabled = true;
    btnText.textContent = 'Invio in corso...';
    submitBtn.classList.add('opacity-75', 'cursor-wait');

    // Icona di caricamento (spinner)
    sendIcon.innerHTML = `
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3a9 9 0 1 0 9 9"></path>
    `;
    sendIcon.classList.add('animate-spin');

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        // Successo - cambia colore e testo
        submitBtn.classList.remove('bg-primary', 'hover:bg-primary/90', 'opacity-75', 'cursor-wait');
        submitBtn.classList.add('bg-green-600', 'hover:bg-green-600');
        btnText.textContent = 'Richiesta inviata!';
        sendIcon.classList.remove('animate-spin');
        sendIcon.innerHTML = `
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M5 12l5 5l10 -10"></path>
        `;

        // Reset del form
        form.reset();

        // Dopo 4 secondi, ripristina il pulsante
        setTimeout(() => {
          submitBtn.classList.remove('bg-green-600', 'hover:bg-green-600');
          submitBtn.classList.add('bg-primary', 'hover:bg-primary/90');
          btnText.textContent = 'Invia richiesta';
          sendIcon.innerHTML = `
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M10 14l11 -11"></path>
            <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5"></path>
          `;
          submitBtn.disabled = false;
        }, 4000);
      } else {
        throw new Error('Errore nella risposta');
      }
    } catch {
      // Errore - mostra stato di errore
      submitBtn.classList.remove('bg-primary', 'hover:bg-primary/90', 'opacity-75', 'cursor-wait');
      submitBtn.classList.add('bg-red-600', 'hover:bg-red-600');
      btnText.textContent = 'Errore, riprova';
      sendIcon.classList.remove('animate-spin');
      sendIcon.innerHTML = `
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M18 6l-12 12"></path>
        <path d="M6 6l12 12"></path>
      `;

      // Dopo 3 secondi, ripristina il pulsante
      setTimeout(() => {
        submitBtn.classList.remove('bg-red-600', 'hover:bg-red-600');
        submitBtn.classList.add('bg-primary', 'hover:bg-primary/90');
        btnText.textContent = 'Invia richiesta';
        sendIcon.innerHTML = `
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M10 14l11 -11"></path>
          <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5"></path>
        `;
        submitBtn.disabled = false;
      }, 3000);
    }
  });
</script>
